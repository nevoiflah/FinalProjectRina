<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>AI Robot Assistant â€¢ Login</title>
	<link rel="stylesheet" href="./styles.css">
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="auth-page">
	<div class="auth-shell">
		<section class="auth-panel auth-hero">
			<div class="robot-icon">ðŸ¤–</div>
			<h1>AI Robot Assistant</h1>
			<p>Create natural conversations with voice or text, keep transcripts synced, and let the bot speak back instantly.</p>

			<div class="auth-badges">
				<span class="auth-badge">Secure</span>
				<span class="auth-badge">Voice + Text</span>
				<span class="auth-badge">24/7 Availability</span>
			</div>

			<ul class="auth-benefits">
				<li>Seamless speech-to-text and text-to-speech loops</li>
				<li>Cloud-synced conversations across devices</li>
				<li>Smart assistant that remembers recent context</li>
			</ul>
		</section>

		<section class="auth-panel auth-card">
			<div class="auth-header">
				<h2 class="auth-title">Welcome back</h2>
				<p class="auth-subtitle">Sign in to continue your session</p>
			</div>

			<form id="loginForm" class="auth-form">
				<div class="auth-field">
					<label for="email">Email address</label>
					<input type="email" id="email" class="message-input" placeholder="ada@example.com" autocomplete="email" required>
				</div>

				<div class="auth-field">
					<label for="password">Password</label>
					<input type="password" id="password" class="message-input" placeholder="Enter your password" autocomplete="current-password" required>
				</div>

				<button type="submit" class="primary-btn">Sign in</button>
			</form>

			<div class="auth-status" id="loginStatus"></div>
			
			<div class="auth-links">
				<span>Don't have an account? <a class="link-btn" href="register.html">Create account</a></span>
			</div>
		</section>
	</div>

	<script src="./config.js"></script>
	<script>
		(function () {
			const ChatConfig = window.ChatConfig;
			const form = document.getElementById('loginForm');
			const statusEl = document.getElementById('loginStatus');
			const submitBtn = form.querySelector('button[type="submit"]');

			function setStatus(message, isError = false) {
				statusEl.textContent = message;
				statusEl.style.color = isError ? '#ff6b6b' : 'var(--text-light)';
			}

			function redirectToChat() {
				window.location.href = 'index.html';
			}

			function getApiBase() {
				const base = ChatConfig?.getApiBase() || '';
				// Default to localhost if not configured
				return base || 'http://localhost:5000';
			}

			// Check if already logged in
			if (localStorage.getItem('chatUser')) {
				setStatus('You are already logged in. Redirecting...');
				setTimeout(redirectToChat, 800);
				return;
			}

			async function login(payload) {
				const apiBase = getApiBase();
				const response = await fetch(`${apiBase}/api/user/login`, {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify(payload),
				});
				
				const data = await response.json().catch(() => ({}));
				
				if (!response.ok) {
					if (response.status === 405 || response.status === 404) {
						throw new Error('Cannot connect to server. Please check if the server is running.');
					}
					if (response.status === 401) {
						throw new Error('Invalid email or password.');
					}
					throw new Error(data?.error || 'Login failed. Please try again.');
				}
				return data;
			}

			form.addEventListener('submit', async (event) => {
				event.preventDefault();
				
				const email = document.getElementById('email').value.trim();
				const password = document.getElementById('password').value;

				// Validation
				if (!email || !password) {
					setStatus('Please enter your email and password.', true);
					return;
				}

				// Email validation
				const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
				if (!emailRegex.test(email)) {
					setStatus('Please enter a valid email address.', true);
					return;
				}

				submitBtn.disabled = true;
				setStatus('Authenticating...');

				try {
					const user = await login({ email, password });
					
					// Store user data in localStorage
					localStorage.setItem('chatUser', JSON.stringify(user));
					
					setStatus('Login successful! Redirecting...');
					setTimeout(redirectToChat, 1000);
				} catch (err) {
					setStatus(err.message || 'Login failed. Please try again.', true);
				} finally {
					submitBtn.disabled = false;
				}
			});
		})();
	</script>
</body>
</html>